// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core tenant and client management
model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clients          Client[]
  users            User[]
  media            Media[]
  products         Product[]
  productCategories ProductCategory[]
  posts       Post[]
  integrations Integration[]
  orders      Order[]
  tariffs     Tariff[]
  invoices    Invoice[]
  usageEvents UsageEvent[]
  suppliers   Supplier[]
  receipts    Receipt[]
  carts       Cart[]
  contactMessages ContactMessage[]

  @@map("tenants")
}

model Client {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users        Membership[]
  posts        Post[]
  integrations Integration[]
  media        Media[]
  clientTariffs ClientTariff[]
  invoices      Invoice[]
  usageEvents   UsageEvent[]

  @@index([tenantId])
  @@map("clients")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         String   @default("staff") // 'admin' | 'staff' (tenant-level)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberships  Membership[]
  refreshTokens RefreshToken[]
  priceOverrides Order[] @relation("OrderPriceOverrideByUser")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Membership {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  clientId  String   @map("client_id")
  role      String   // 'admin' | 'staff'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
  @@map("memberships")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// Media management
model Media {
  id        String    @id @default(uuid())
  tenantId  String    @map("tenant_id")
  clientId  String?   @map("client_id")
  url       String
  mimeType  String    @map("mime_type")
  size      Int
  width     Int?
  height    Int?
  duration  Int?      // for videos, in seconds
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  postMedia   PostMedia[]
  productImages ProductImage[]

  @@index([tenantId])
  @@index([clientId])
  @@map("media")
}

// Suppliers
model Supplier {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  name      String
  phone     String?
  email     String?
  address   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([tenantId])
  @@map("suppliers")
}

// Product categories (tenant-scoped)
model ProductCategory {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  name      String
  slug      String
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("product_categories")
}

// Product catalog (shop - tenant + supplier, no client)
model Product {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  supplierId      String   @map("supplier_id")
  categoryId      String?  @map("category_id")
  title           String
  description     String   @db.Text
  price           Decimal  @db.Decimal(10, 2) // Legacy field, use listPrice
  currency        String   @default("KES")
  slug            String
  status          String   @default("draft") // 'draft' | 'published'
  supplyPrice     Decimal  @db.Decimal(10, 2) @map("supply_price") // What you pay supplier
  minSellPrice    Decimal  @db.Decimal(10, 2) @map("min_sell_price") // Floor price
  listPrice       Decimal  @db.Decimal(10, 2) @map("list_price") // Price shown on shop
  priceDisclaimer String?  @db.Text @map("price_disclaimer") // e.g. "slightly negotiable"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier      Supplier       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  category      ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants      ProductVariant[]
  images        ProductImage[]
  postProducts  PostProduct[]
  orderItems    OrderItem[]
  cartItems     CartItem[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([supplierId])
  @@index([categoryId])
  @@index([status])
  @@map("products")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String  @map("product_id")
  sku       String
  name      String   // e.g., "64GB", "128GB" (storage option)
  stock     Int      @default(0)
  price     Decimal? @db.Decimal(10, 2)  // optional: price for this variant (storage); when set, overrides product listPrice
  currency  String?  @db.VarChar(3)      // optional: e.g. "KES"; when null, use product.currency
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  mediaId   String   @map("media_id")
  order     Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  media   Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([mediaId])
  @@map("product_images")
}

// Social media posts
model Post {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  clientId    String   @map("client_id")
  status      String   @default("draft") // 'draft' | 'scheduled' | 'publishing' | 'published' | 'failed'
  scheduledAt DateTime? @map("scheduled_at")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  captions        PostCaption[]
  media           PostMedia[]
  products        PostProduct[]
  destinations    PostDestination[]

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledAt])
  @@map("posts")
}

model PostCaption {
  id          String   @id @default(uuid())
  postId      String   @map("post_id")
  platform    String   // 'facebook' | 'instagram' | 'tiktok' | 'twitter'
  caption     String   @db.Text
  hashtags    String?  @db.Text  // e.g. "#sale #newarrival"
  includeLink Boolean  @default(false) @map("include_link")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, platform])
  @@index([postId])
  @@map("post_captions")
}

model PostMedia {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  mediaId   String   @map("media_id")
  order     Int      @default(0)
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([mediaId])
  @@map("post_media")
}

model PostProduct {
  id         String   @id @default(uuid())
  postId     String   @map("post_id")
  productId  String   @map("product_id")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now())

  post    Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([productId])
  @@map("post_products")
}

// Social media integrations
model Integration {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  clientId     String    @map("client_id")
  provider     String    // 'facebook' | 'instagram' | 'tiktok' | 'twitter'
  externalId   String    @map("external_id")
  accessToken  String    @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  expiresAt    DateTime? @map("expires_at")
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  destinations Destination[]

  @@index([tenantId])
  @@index([clientId])
  @@index([provider])
  @@map("integrations")
}

model Destination {
  id           String   @id @default(uuid())
  integrationId String  @map("integration_id")
  type         String   // 'facebook_page' | 'instagram_business' | 'tiktok_account' | 'twitter_account'
  externalId   String   @map("external_id")
  name         String
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  integration    Integration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  postDestinations PostDestination[]

  @@index([integrationId])
  @@index([type])
  @@map("destinations")
}

model PostDestination {
  id             String    @id @default(uuid())
  postId         String    @map("post_id")
  destinationId  String    @map("destination_id")
  status         String    @default("draft") // 'draft' | 'scheduled' | 'publishing' | 'published' | 'failed'
  externalPostId String?   @map("external_post_id")
  postUrl        String?   @map("post_url")   // Link to published post on platform
  mediaIds       Json?     @map("media_ids")  // Optional: media IDs for this destination (overrides post media)
  error          String?   @db.Text
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  post        Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  destination Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)

  @@unique([postId, destinationId])
  @@index([postId])
  @@index([destinationId])
  @@index([status])
  @@map("post_destinations")
}

// Cart (standalone shop - tenant-scoped)
model Cart {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  cartToken String   @map("cart_token")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  CartItem[]

  @@unique([tenantId, cartToken])
  @@index([tenantId])
  @@index([tenantId, cartToken])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  quantity  Int
  createdAt DateTime @default(now()) @map("created_at")

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// Orders (standalone shop - tenant-scoped)
model Order {
  id                 String    @id @default(uuid())
  tenantId           String    @map("tenant_id")
  publicId           String    @unique @map("public_id")
  customerName       String    @map("customer_name")
  customerEmail      String    @map("customer_email")
  customerPhone      String?   @map("customer_phone")
  customerAddress    String?   @map("customer_address") @db.Text
  deliveryType       String    @default("pickup") @map("delivery_type") // 'pickup' | 'delivery'
  customerPreference String?   @map("customer_preference") @db.Text
  status             String    @default("pending") // 'pending' | 'contacted' | 'quoted' | 'complete' | 'cancelled'
  isGenuine          Boolean?  @map("is_genuine") // null = not reviewed, true/false after attendant review
  fulfillmentNotes   String?   @map("fulfillment_notes") @db.Text
  total              Decimal   @db.Decimal(10, 2)
  quotedTotal        Decimal?  @map("quoted_total") @db.Decimal(10, 2)
  finalTotal         Decimal?  @map("final_total") @db.Decimal(10, 2)
  priceOverrideByUserId String? @map("price_override_by_user_id")
  priceOverrideReason   String? @map("price_override_reason") @db.Text
  currency           String    @default("KES")
  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  priceOverrideByUser User? @relation("OrderPriceOverrideByUser", fields: [priceOverrideByUserId], references: [id], onDelete: SetNull)
  items  OrderItem[]
  receipt Receipt?

  @@index([tenantId])
  @@index([publicId])
  @@index([status])
  @@map("orders")
}

// Billing + tariffs
model Tariff {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  name           String
  currency       String   @default("KES")
  minPostsPerWeek Int     @default(0) @map("min_posts_per_week")
  rulesJson      Json     @default("{}") @map("rules_json")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientTariffs  ClientTariff[]

  @@index([tenantId])
  @@map("tariffs")
}

model ClientTariff {
  id           String   @id @default(uuid())
  clientId     String   @map("client_id")
  tariffId     String   @map("tariff_id")
  activeFrom   DateTime @default(now()) @map("active_from")
  activeTo     DateTime? @map("active_to")
  overridesJson Json?   @map("overrides_json")
  createdAt    DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tariff Tariff @relation(fields: [tariffId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([tariffId])
  @@map("client_tariffs")
}

model UsageEvent {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  clientId     String   @map("client_id")
  type         String
  occurredAt   DateTime @default(now()) @map("occurred_at")
  quantity     Int      @default(1)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount       Decimal  @db.Decimal(10, 2)
  metadataJson Json     @default("{}") @map("metadata_json")
  invoiceId    String?  @map("invoice_id")
  createdAt    DateTime @default(now())

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([invoiceId])
  @@index([occurredAt])
  @@map("usage_events")
}

model Invoice {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  clientId    String   @map("client_id")
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  status      String   @default("draft") // draft|issued|paid
  subtotal    Decimal  @db.Decimal(10, 2)
  tax         Decimal  @db.Decimal(10, 2) @default(0)
  total       Decimal  @db.Decimal(10, 2)
  issuedAt    DateTime? @map("issued_at")
  paidAt      DateTime? @map("paid_at")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lines       InvoiceLine[]
  usageEvents UsageEvent[]

  @@index([tenantId])
  @@index([clientId])
  @@index([periodStart])
  @@index([periodEnd])
  @@map("invoices")
}

model InvoiceLine {
  id           String   @id @default(uuid())
  invoiceId    String   @map("invoice_id")
  description  String
  quantity     Int      @default(1)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount       Decimal  @db.Decimal(10, 2)
  metadataJson Json     @default("{}") @map("metadata_json")
  createdAt    DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_lines")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Receipts (shop orders)
model Receipt {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  orderId       String   @unique @map("order_id")
  receiptNumber String   @unique @map("receipt_number")
  issuedAt      DateTime @default(now()) @map("issued_at")
  totalPaid     Decimal  @map("total_paid") @db.Decimal(10, 2)
  paymentMethod String   @map("payment_method") // 'card', 'cash', 'bank_transfer', etc.
  metadataJson  Json     @default("{}") @map("metadata_json")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@index([receiptNumber])
  @@map("receipts")
}

// Audit logs
model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  userId     String?  @map("user_id")
  action     String   // e.g., 'integration.connect', 'post.publish', 'product.update', 'order.status_change'
  entityType String   @map("entity_type") // e.g., 'integration', 'post', 'product', 'order'
  entityId   String?  @map("entity_id")
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ContactMessage {
  id        String    @id @default(uuid())
  tenantId  String    @map("tenant_id")
  name      String
  phone     String
  message   String    @db.Text
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdAt])
  @@map("contact_messages")
}
